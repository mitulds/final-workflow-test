name: 'Sync: Main to QA (Direct PR)'

on:
  pull_request:
    types: [closed]
    branches: ['main']

jobs:
  create-sync-pull-request:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      # We only need permission to create PRs, not write content.
      pull-requests: write
      contents: read # Best practice to grant read-only for contents

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: 🔎 Check for differences before creating PR
        id: diff_check
        run: |
          # Count commits in main that are not in qa.
          # We fetch to ensure our remote refs are up to date.
          git fetch
          DIFF_COUNT=$(git rev-list --count origin/qa..origin/main)
          echo "Found $DIFF_COUNT new commits in main to sync."
          echo "count=$DIFF_COUNT" >> "$GITHUB_OUTPUT"

      - name: 🚀 Create Pull Request if changes exist
        if: steps.diff_check.outputs.count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base qa \
            --head main \
            --title "🤖 Sync: Merge main into qa" \
            --body-file .github/PULL_REQUEST_TEMPLATE.md
